import os
import cupy as cp
import cudf
import pandas as pd
import pytest

import genboostgpu.pipeline as pipeline


@pytest.fixture
def toy_data(tmp_path, monkeypatch):
    """
    Create toy geno/phenotype data and patch boosting_elastic_net
    to return a simple mock result.
    """
    # Fake bim annotation
    bim = cudf.DataFrame({
        "chrom": ["1", "1", "1"],
        "pos": [1000, 2000, 3000],
        "snp": ["snp1", "snp2", "snp3"]
    })

    # Fake genotypes (2 samples x 3 SNPs)
    geno_df = cudf.DataFrame({
        "snp1": [0, 1],
        "snp2": [1, 2],
        "snp3": [0, 0],
    })

    # Fake phenotypes (2 samples x 1 CpG)
    pheno_df = cudf.DataFrame({
        "cg0001": [0.5, -0.2]
    })

    cpg_list = [("cg0001", 1, 2000)]

    # Monkeypatch boosting_elastic_net
    def fake_boosting_elastic_net(X, y, snp_ids, **kwargs):
        return {
            "betas_boosting": cp.array([0.1, 0.0, -0.2]),
            "ridge_betas_full": cp.array([0.1, 0.0, -0.2]),
            "snp_ids": snp_ids,
            "snp_variances": cp.array([1.0, 1.0, 1.0]),
            "kept_snps": snp_ids,
            "h2_estimates": [0.01, 0.02],
            "final_r2": 0.5,
            "h2_unscaled": 0.03,
            "best_enet": {"alpha": 0.1, "l1_ratio": 0.5},
            "best_ridge": {"alpha": 1.0},
        }
    monkeypatch.setattr(pipeline, "boosting_elastic_net", fake_boosting_elastic_net)

    return {
        "bim": bim,
        "geno_df": geno_df,
        "pheno_df": pheno_df,
        "cpg_list": cpg_list,
        "tmpdir": tmp_path,
    }
